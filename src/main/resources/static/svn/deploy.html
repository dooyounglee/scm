<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link href="/css/main.css" rel="stylesheet" type="text/css"></style>
        <script
            src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"></script>
        <script src="/js/common.js"></script>
        <script>
            $(function(){
                selectApplys();
                selectRevisions();
                
            });

            let deployList = [];
                
            function addDeployList() {
                var selectedRevision = $("#selectedRevision").text();
                $("input[name='path']:checked").each((i,e) => {
                    var index = deployList.findIndex(i => i.path == e.value.substring(1) && i.revision == selectedRevision);
                    if (index > -1) return false;

                    var obj = {};
                    obj["revision"] = selectedRevision;
                    obj["path"] = e.value.substring(1);
                    deployList.push(obj);
                });

                showList();
            }

            function removeDeployList(path, revision) {
                var index = deployList.findIndex(i => i.path == path && i.revision == revision);
                deployList.splice(index,1);

                showList();
            }

            function showList() {
                $("#deployList").html('');
                deployList.sort((a,b) => {
                    if (a.path < b.path) return -1;
                    if (a.path > b.path) return 1;
                    return a.revision - b.revision;
                });
                deployList.forEach(element => {
                    var str = "<tr>";
                    str += "<td>" + element.path + "</td>";
                    str += "<td>" + element.revision + "</td>";
                    str += `<td><button onclick='removeDeployList("\${element.path}","\${element.revision}")'>삭제</button></td>`;
                    str += "</tr>";
                    $("#deployList").append(str);
                });
            }

            function insertApply() {
                $.ajax({
                    type: 'post',
                    url: '/svn/insertApply',
                    async: true,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    dataType: 'json',
                    data: JSON.stringify(deployList),
                    success: (result) => {
                        selectApplys();

                        $("#selectedRevision").html('');
                        $("#changedPath").html('');
                        $("#deployList").html('');
                        deployList = [];
                        showList();
                    },
                    error: (request, status, error) => {
                        console.log(request);
                    }
                });
            }

            function updateReadyApply(applyNo) {
                $.ajax({
                    type: 'post',
                    url: '/svn/updateReadyApply',
                    async: true,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    dataType: 'json',
                    data: JSON.stringify({
                        applyNo: applyNo,
                    }),
                    success: (result) => {
                        selectApplys();

                        $("#selectedRevision").html('');
                        $("#changedPath").html('');
                        $("#deployList").html('');
                        deployList = [];
                        showList();
                    },
                    error: (request, status, error) => {
                        console.log(request);
                    }
                });
            }

            function cancleReadyApply(applyNo) {
                $.ajax({
                    type: 'post',
                    url: '/svn/cancleReadyApply',
                    async: true,
                    headers: {
                        "Content-Type": "application/json",
                    },
                    dataType: 'json',
                    data: JSON.stringify({
                        applyNo: applyNo,
                    }),
                    success: (result) => {
                        selectApplys();

                        $("#selectedRevision").html('');
                        $("#changedPath").html('');
                        $("#deployList").html('');
                        deployList = [];
                        showList();
                    },
                    error: (request, status, error) => {
                        console.log(request);
                    }
                });
            }

            function selectAll(input_check) {
                $("input[name='path']").each((i,e) => {
                    e.checked = input_check.checked;
                });
            }
        </script>
    </head>
    <body>
        <h3>메인</h3>

        <div>
            <table>
                <thead>
                    <tr>
                        <td>applyNo</td>
                        <td>applyDt</td>
                        <td>applySt</td>
                        <td>상세</td>
                        <td>배포상태</td>
                    </tr>
                </thead>
                <tbody id="applys">
                </tbody>
            </table>
            <br>
        </div>

        <div>
            <div id="selectedApplyNo"></div>
            <table>
                <thead>
                    <tr>
                        <td>path</td>
                        <td>revision</td>
                    </tr>
                </thead>
                <tbody id="applyFiles">
                </tbody>
            </table>
            <br>
        </div>

        <hr>

        <div>
            <table>
                <thead>
                    <tr>
                        <td>revision</td>
                        <td>author</td>
                        <td>date</td>
                        <td>message</td>
                        <td>#file</td>
                        <td>상세</td>
                    </tr>
                </thead>
                <tbody id="revisions">
                </tbody>
            </table>
            <br>
        </div>

        <div>
            <div id="selectedRevision"></div>
            <button onclick="addDeployList()">추가</button>
            <table>
                <thead>
                    <tr>
                        <td><input type="checkbox" onclick="selectAll(this);"></td>
                        <td>type</td>
                        <td>path</td>
                        <td>copyPath</td>
                        <td>copyRevision</td>
                        <td>kind</td>
                        <td>선택</td>
                        <td>내용</td>
                    </tr>
                </thead>
                <tbody id="changedPath"></tbody>
            </table>
            <br>
        </div>
        
        <div>
            <button onclick="insertApply()">배포요청</button>
            <table>
                <thead>
                    <tr>
                        <td>path</td>
                        <td>revision</td>
                        <td>삭제</td>
                    </tr>
                </thead>
                <tbody id="deployList">
                </tbody>
            </table>
            <br>
        </div>
    </body>
</html>